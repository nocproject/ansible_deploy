---
- name: Prepare
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: expose vars to playbook
      set_fact:
        use_cache: "{{ lookup('env','USE_CACHE') or True | bool }}"
        minio_url: "{{ lookup('env','MINIO_URL') }}"
        minio_key: "{{ lookup('env','MINIO_KEY') }}"
        minio_secret: "{{ lookup('env','MINIO_SECRET') }}"
        minio_bucket: "myminio/{{inventory_hostname | replace('_','-')}}"
        pip_cache_dir: "{{ lookup('env','PIP_CACHE') }}"
        pkg_cache_dir: "{{ lookup('env','PKG_CACHE') }}"

    - block:
        - name: create dist dir
          file:
            path: /tmp/dist/
            state: directory
            owner: root
            group: root
          connection: local

        - name: install minio client
          become: false
          get_url:
            url: https://dl.minio.io/client/mc/release/linux-amd64/mc
            dest: /tmp/dist/mc
          connection: local

        - name: upload mc client to node
          copy:
            src: /tmp/dist/mc
            dest: /tmp/mc
            mode: 0755

        - name: config cache url
          command: "/tmp/mc config host add myminio {{ minio_url }} {{minio_key}} {{minio_secret}}"

        - name: create minio bucket
          command: "/tmp/mc mb {{ minio_bucket }}"
          ignore_errors: true
          failed_when: false

        - name: create cache dir
          file:
            path: "{{ pip_cache_dir }}"
            state: directory
            owner: root
            group: root

        - name: download pip cache
          command: "/tmp/mc mirror {{ minio_bucket }}/pip {{ pip_cache_dir }}"

        - name: download pkg cache
          command: "/tmp/mc mirror {{ minio_bucket }}/pkgs {{pkg_cache_dir}}"

      when: use_cache
