---
- name: Upload cache
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: export use_cache var
      set_fact:
        use_cache: "{{ lookup('env','USE_CACHE') or True | bool }}"

    - block:
        - name: upload pip cache
          shell: /tmp/mc mirror $PIP_CACHE myminio/{{inventory_hostname | replace('_','-')}}/pip

        - name: upload apt cache
          shell: /tmp/mc mirror $PKG_CACHE myminio/{{inventory_hostname | replace('_','-')}}/pkgs
      when: use_cache

- name: Destroy
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Destroy molecule instance(s)
      vmware_guest:
        hostname: "{{ molecule_yml.driver.hostname }}"
        esxi_hostname: "{{ molecule_yml.driver.esxi_hostname }}"
        username: "{{ molecule_yml.driver.username }}"
        password: "{{ molecule_yml.driver.password }}"
        datacenter: "{{ molecule_yml.driver.datacenter }}"
        validate_certs: "{{ molecule_yml.driver.validate_certs }}"
        resource_pool: "{{ molecule_yml.driver.resource_pool }}"
        folder: "{{ molecule_yml.driver.hostname }}"
        name: "{{ item.name }}"
        state: absent
        force: "yes"
      register: server
      with_items: "{{ molecule_yml.platforms }}"

    - name: Populate instance config
      set_fact:
        instance_conf: {}

    - name: Dump instance config
      copy:
        # NOTE(retr0h): Workaround for Ansible 2.2.
        #               https://github.com/ansible/ansible/issues/20885
        content: "{{ instance_conf | to_json | from_json | molecule_to_yaml | molecule_header }}"
        dest: "{{ molecule_instance_config }}"
      when: server is changed
