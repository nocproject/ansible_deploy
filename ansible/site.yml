---
- name: pre tasks
  hosts: all
  become: no
  any_errors_fatal: false
  gather_facts: True
  vars_files:
    - "vars/main.yml"
  vars:
    ansible_tags: "{{ lookup('get_tags') }}"
  roles:
    - role: pre

- name: clickhouse tasks
  hosts: svc-clickhouse
  become: yes
  any_errors_fatal: false
  gather_facts: True
  tags:
    - clickhouse
  vars_files:
    - "vars/main.yml"
  roles:
    - role: clickhouse

- name: Common tasks
  hosts: all
  become: yes
  any_errors_fatal: false
  gather_facts: True
  tags:
    - telegraf
  vars_files:
    - "vars/main.yml"
  roles:
    - role: telegraf


- name: haproxy tasks
  hosts: svc-haproxy
  become: yes
  any_errors_fatal: True
  gather_facts: True
  tags:
    - haproxy
    - ha
  vars_files:
    - "vars/main.yml"
  roles:
    - role: haproxy


- name: keepalived tasks
  hosts: svc-keepalived
  become: yes
  any_errors_fatal: True
  gather_facts: True
  tags:
    - keepalived
    - ha
  vars_files:
    - "vars/main.yml"
  roles:
    - role: keepalived


- name: Consul tasks
  hosts: svc-consul-server
  become: yes
  any_errors_fatal: true
  gather_facts: True
  tags:
    - consul
  vars_files:
    - "vars/main.yml"
  roles:
    - role: consul

- name: Consul tasks
  hosts: all
  become: yes
  any_errors_fatal: false
  serial: 50%
  gather_facts: True
  vars_files:
    - "vars/main.yml"
  roles:
    - role: consul
      tags:
        - consul

    - role: consul-template
      tags:
        - consul-template
        - external

- name: Install NOC
  hosts: all
  become: yes
  any_errors_fatal: false
  gather_facts: True
  tags:
    - node
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: node

- name: Install and configure patroni
  hosts: svc-patroni
  become: yes
  serial: 1
  any_errors_fatal: true
  tags:
    - postgres
    - patroni
    - external
    - ha
  vars_files:
    - "vars/main.yml"
  roles:
    - role: patroni

- name: Install and configure postgres
  hosts: svc-postgres
  become: yes
  serial: 1
  any_errors_fatal: true
  tags:
    - postgres
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: postgres

- name: Install and configure grafana
  hosts: svc-grafana
  become: yes
  serial: 50%
  any_errors_fatal: true
  tags:
    - grafana
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: grafana

- name: Install and configure nsq
  hosts: all
  become: yes
  any_errors_fatal: true
  tags:
    - nsq
    - nsqd
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: nsqd

- name: Install and configure nsqlookupd
  hosts: svc-nsqlookupd
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - nsq
    - nsqlookupd
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: nsqlookupd

- name: Install and configure mongo
  hosts: svc-mongod
  become: yes
  serial: 30%
  any_errors_fatal: true
  tags:
    - mongod
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: mongod

- name: Install and configure pgbouncer
  hosts: svc-pgbouncer
  become: yes
  any_errors_fatal: true
  tags:
    - pgbouncer
    - external
  strategy: free
  vars_files:
    - "vars/main.yml"
  roles:
    - role: pgbouncer

- name: Install and configure influxdb
  hosts: svc-influxdb
  become: yes
  serial: 1
  tags:
    - influxdb
    - external
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  roles:
    - role: influxdb

- name: Install and configure nginx
  hosts: svc-nginx
  serial: 50%
  become: yes
  tags:
    - nginx
    - web
    - external
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  roles:
    - role: nginx

- name: Install and configure memcached
  hosts: svc-memcached
  become: yes
  any_errors_fatal: true
  tags:
    - memcached
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: memcached

- name: Install and upgrade NOC
  hosts: svc-login
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - login
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: login


- name: Install and upgrade NOC
  hosts: svc-mrt
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - mrt
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: mrt


- name: Install and upgrade NOC
  hosts: svc-escalator
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - escalator
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: escalator

- name: Install and upgrade NOC
  hosts: svc-web
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - node
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: web

- name: Install and upgrade NOC
  hosts: svc-card
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - card
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: card

- name: Install and upgrade NOC
  hosts: svc-omap
  become: yes
  strategy: free
  tags:
    - omap
    - noc
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  roles:
    - role: omap

- name: Install and upgrade NOC
  hosts: svc-activator
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - activator
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: activator

- name: Install and upgrade NOC
  hosts: svc-grafanads
  become: yes
  strategy: free
  tags:
    - node
    - noc
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  roles:
    - role: grafanads

- name: Install and upgrade NOC
  hosts: svc-mailsender
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - mailsender
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: mailsender

- name: Install and upgrade NOC
  hosts: svc-tgsender
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - tgsender
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: tgsender

- name: Install and upgrade NOC
  hosts: svc-pmwriter
  become: no
  strategy: free
  any_errors_fatal: true
  tags:
    - pmwriter
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: pmwriter
      become: yes

- name: Install and upgrade NOC
  hosts: svc-chwriter
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - chwriter
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: chwriter

- name: Install and upgrade NOC
  hosts: svc-classifier
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - classifier
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: classifier

- name: Install and upgrade NOC
  hosts: svc-correlator
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - correlator
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: correlator

- name: Install and upgrade NOC
  hosts: svc-syslogcollector
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - syslogcollector
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: syslogcollector

- name: Install and upgrade NOC
  hosts: svc-trapcollector
  strategy: free
  become: yes
  any_errors_fatal: true
  tags:
    - trapcollector
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: trapcollector

- name: Install and upgrade NOC
  hosts: svc-ping
  strategy: free
  become: yes
  any_errors_fatal: true
  tags:
    - ping
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: ping

- name: Install and upgrade NOC
  hosts: svc-sae
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - sae
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: sae
      become: yes

- name: Install and upgrade NOC
  hosts: svc-scheduler
  become: no
  strategy: free
  any_errors_fatal: true
  tags:
    - scheduler
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: scheduler
      become: yes

- name: Install and upgrade NOC
  hosts: svc-discovery
  become: no
  strategy: free
  any_errors_fatal: true
  tags:
    - discovery
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: discovery
      become: yes

- name: Install and upgrade NOC
  hosts: svc-bi
  become: no
  strategy: free
  any_errors_fatal: true
  tags:
    - bi
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: bi
      become: yes

- name: Install and configure dev tools
  hosts: svc-dev
  strategy: free
  become: yes
  any_errors_fatal: false
  tags:
    - dev
  vars_files:
    - "vars/main.yml"
  roles:
    - role: dev
      become: yes
      when: "has_svc_dev | default(False) or has_svc_notebook | default(False) or consul_env"

    - role: notebook
      become: yes
      when: "has_svc_notebook | default(False) or consul_env"
      tags:
        - notebook
        - external

    - role: nsqadmin
      become: yes
      when: "has_svc_nsqadmin | default(False) or consul_env"
      tags:
        - nsq
        - nsqadmin
        - external

- name: Finally
  hosts: all
  become: no
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  vars:
    ansible_tags: "{{ lookup('get_tags') }}"
  roles:
    - role: migrate
      become: yes
      run_once: true
      tags:
        - migrate

    - role: post
      become: yes
      tags:
        - post