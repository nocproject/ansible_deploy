---
- name: pre tasks
  hosts: all
  become: no
  any_errors_fatal: false
  gather_facts: True
  vars_files:
    - "vars/main.yml"
  vars:
    ansible_tags: "{{ lookup('get_tags') }}"
  roles:
    - role: pre

- name: Consul tasks
  hosts: svc-consul-server
  become: yes
  any_errors_fatal: true
  gather_facts: True
  tags:
    - consul
  vars_files:
    - "vars/main.yml"
  roles:
    - role: consul

- name: Consul tasks
  hosts: all
  become: yes
  any_errors_fatal: false
  serial: 50%
  gather_facts: True
  vars_files:
    - "vars/main.yml"
  roles:
    - role: consul
      tags:
        - consul

    - role: consul-template
      tags:
        - consul-template
        - external

- name: Install and configure postgres
  hosts: svc-postgres-exec
  become: yes
  serial: 1
  any_errors_fatal: true
  tags:
    - postgres
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: postgres

- name: Install and configure grafana
  hosts: svc-grafana-exec
  become: yes
  serial: 50%
  any_errors_fatal: true
  tags:
    - grafana
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: grafana

- name: Install and configure nsqlookupd
  hosts: svc-nsqlookupd-exec
  become: yes
  strategy: free
  any_errors_fatal: true
  tags:
    - nsq
    - nsqlookupd
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: nsqlookupd

- name: Install and configure nsq
  hosts: svc-nsqd-exec
  become: yes
  any_errors_fatal: true
  tags:
    - nsq
    - nsqd
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: nsqd

- name: Install and configure mongo
  hosts: svc-mongod-exec
  become: yes
  serial: 30%
  any_errors_fatal: true
  tags:
    - mongod
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: mongod

- name: clickhouse tasks
  hosts: svc-clickhouse-exec
  become: yes
  any_errors_fatal: false
  gather_facts: True
  tags:
    - clickhouse
    - external
  vars_files:
    - "vars/main.yml"
  roles:
    - role: clickhouse

- name: Install and configure nginx
  hosts: svc-nginx-exec
  serial: 50%
  become: yes
  tags:
    - nginx
    - web
    - external
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  roles:
    - role: nginx

- name: Install NOC
  hosts: noc-svc-*
  become: yes
  any_errors_fatal: true
  strategy: free
  gather_facts: True
  tags:
    - node
    - noc
  vars_files:
    - "vars/main.yml"
  roles:
    - role: node
    - role: login
    - role: mrt
    - role: escalator
    - role: web
    - role: card
    - role: ch_datasource
    - role: omap
    - role: activator
    - role: grafanads
    - role: mailsender
    - role: tgsender
    - role: chwriter
    - role: classifier
    - role: correlator
    - role: syslogcollector
    - role: trapcollector
    - role: ping
    - role: sae
    - role: scheduler
    - role: discovery
    - role: bi

- name: Finally
  hosts: all
  become: no
  any_errors_fatal: true
  vars_files:
    - "vars/main.yml"
  vars:
    ansible_tags: "{{ lookup('get_tags') }}"
  roles:
    - role: migrate
      become: yes
      run_once: true
      tags:
        - migrate

    - role: post
      become: yes
      tags:
        - post