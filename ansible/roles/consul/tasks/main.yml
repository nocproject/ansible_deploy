---
# File: main.yml - Main tasks for Consul

- name: Expose consul_node_role as fact
  set_fact:
    consul_node_role: "{{ consul_node_role }}"

- name: "Include OS-specific tasks"
  include: "os/{{ ansible_distribution }}/main.yml"

- name: Check bootstrapped state
  stat:
    path: "{{consul_config_path}}/.consul_bootstrapped"
  register: bootstrap_marker
  ignore_errors: true
  tags: always

- name: Include user/group settings
  include: user_group.yml

- name: Include dir settings
  include: dirs.yml

- name: Install OS packages and consul - remotely
  include: install.yml

- name: Consul config
  include: config.yml

- name: ACL config
  include: acl.yml
  when: consul_acl_enable

- block:

  - name: Start Consul
    service:
      name: consul
      state: started
      enabled: yes

  - name: Consul HTTP API reachable?
    wait_for:
      delay: 15
      port: 8500

  - name: Create bootstrapped marker
    file:
      dest: "{{consul_config_path}}/.consul_bootstrapped"
      state: touch

  when: not bootstrap_marker.stat.exists
