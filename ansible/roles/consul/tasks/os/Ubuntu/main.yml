---
- name: systemd script
  template:
    src: consul_systemd.service.j2
    dest: /lib/systemd/system/consul.service
    owner: root
    group: root
    mode: 0644

- name: search for correct consul iface
  shell: "/sbin/ip ro get {{hostvars[groups['svc-consul-server'][0]].ansible_host}} | grep dev | awk '{print $3}'"
  register: consul_route
  changed_when: false
  when: consul_node_role == 'client'

- name: Expose consul_iface as fact
  set_fact:
    consul_iface: "{{consul_route.stdout}}"
  when: consul_node_role == 'client'

- name: Expose consul_bind_address as fact
  set_fact:
    consul_bind_address: "{{ hostvars[inventory_hostname]['ansible_'+ consul_iface ]['ipv4']['address'] }}"
