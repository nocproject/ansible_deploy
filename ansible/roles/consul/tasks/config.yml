---
# File: config.yml - Consul configuration tasks

- name: Bootstrap configuration
  template:
    src: config_bootstrap.json.j2
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group}}"
  with_items:
    - dest: "{{ consul_config_path }}/config.json"
      when: "{{ consul_node_role == 'bootstrap' }}"
  when:
    - item.when
  notify:
    - restart consul
  tags:
    - config

- name: Server configuration
  template:
    src: config_server.json.j2
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group}}"
  with_items:
    - dest: "{{ consul_config_path }}/config.json"
      when: "{{ consul_node_role == 'server' }}"
  when:
    - item.when
  notify:
    - restart consul
  tags:
    - config

- name: Client configuration
  template:
    src: config_client.json.j2
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group}}"
  with_items:
    - dest: "{{ consul_config_path }}/config.json"
      when: "{{ consul_node_role == 'client' }}"
  when:
    - item.when
  notify:
    - restart consul
  tags:
    - config

- name: Perfomance configuration
  template:
    src: perfomance.json.j2
    dest: "{{ consul_configd_path }}/perfomance.json"
    owner: "{{ consul_user }}"
    group: "{{ consul_group}}"
  when: "'prod' in noc_env_type"
  notify:
    - restart consul
  tags:
    - config

- name: setup resolv.conf
  lineinfile:
    line: "search service.{{consul_datacenter}}.{{consul_domain}}"
    dest: /etc/resolv.conf
    regexp: "^search.+"
  when: "'prod' in noc_env_type"
  tags:
    - config