---
- name: create consul-template directory structure
  file:
    state: directory
    path: "{{ item }}"
  with_items:
    - "{{ consul_template_config_dir }}"
    - "{{consul_template_templates_dir}}"

- name: Get Consul-template package checksum file
  get_url:
    url: "{{ consul_template_checksum_file_url }}"
    dest: "{{ consul_template_temp_file_checksum }}"
    validate_certs: no
  delegate_to: 127.0.0.1
  become: no
  run_once: yes
  tags:
    - requirements
  environment:
    https_proxy: "{{http_proxy}}"

- name: Get Consul-template package checksum
  shell: "grep {{ consul_template_pkg }} {{ consul_template_temp_file_checksum }}"
  register: consul_sha256
  delegate_to: 127.0.0.1
  become: no
  run_once: yes
  changed_when: false
  tags:
    - requirements

- name: Download Consul-template
  get_url:
    url: "{{ consul_template_zip_url }}"
    dest: "{{consul_template_temp_file}}"
    checksum: "sha256:{{ consul_sha256.stdout.split(' ')|first }}"
    timeout: 42
    validate_certs: no
  delegate_to: 127.0.0.1
  become: no
  run_once: yes
  tags:
    - requirements
  environment:
    https_proxy: "{{http_proxy}}"

- name: Unarchive Consul-template and install binary
  unarchive:
    src: "{{consul_template_temp_file}}"
    dest: "{{ consul_template_bin_path }}"
    owner: "{{ consul_template_user }}"
    group: "{{ consul_template_group }}"
    mode: 0755
    creates: "{{ consul_template_bin_path }}/{{consul_template_binary}}"
  tags:
    - requirements


- name: consul-template config file
  template:
    src: "{{ consul_template_config_file_template }}"
    dest: "{{consul_template_config_dir}}/{{ consul_template_config_file }}"
    mode: 0755
  notify:
    - reload consul-template
  tags:
    - config

- name: copy consul-template systemd service configuration
  template:
    src: consul-template.service.j2
    dest: /etc/systemd/system/consul-template.service
    mode: 0755
  when: "'Linux' in ansible_system"
  notify:
    - reload systemd
    - restart consul-template
  tags:
    - config

- name: copy consul-template bsdinit service configuration
  template:
    src: consul-template.bsdinit.j2
    dest: "{{etc_prefix}}/rc.d/consul-template"
    mode: 0755
  when: "'FreeBSD' in ansible_system"
  tags:
    - config

- name: include services
  include: "services.yml"

- name: start consul-template service
  service:
    name: consul-template
    state: started
    enabled: yes
