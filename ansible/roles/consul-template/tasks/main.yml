---
- name: create consul-template directory structure
  file:
    state: directory
    path: "{{ item }}"
  with_items:
    - "{{ consul_template_config_dir }}"
    - "{{consul_template_templates_dir}}"

- name: check archive stat
  stat:
    path: /tmp/{{ consul_template_archive_file }}
  register: consul_template_archive_stat
  tags:
    - requirements

- name: download consul-template binary
  get_url:
    url: "{{ consul_template_download_url }}"
    dest: "{{consul_template_dl_dir}}"
    validate_certs: no
  when: consul_template_archive_stat.stat.exists == False
  tags:
    - requirements
  environment:
    https_proxy: "{{http_proxy}}"

- name: unzip the downloaded package
  unarchive:
    src: "{{consul_template_dl_dir}}/{{ consul_template_archive_file }}"
    dest: "{{consul_template_dl_dir}}"
    owner: "root"
    group: "{% if 'FreeBSD' in ansible_system %}wheel{%else%}root{%endif%}"
    copy: False
    creates: "{{consul_template_dl_dir}}/{{ consul_template_binary }}"
  tags:
    - requirements

- name: copy consul-template binary into place
  copy:
    src: "{{consul_template_dl_dir}}/{{ consul_template_binary }}"
    dest: "{{consul_template_bin_path}}/{{ consul_template_binary }}"
    remote_src: yes
  tags:
    - requirements

- name: Update consul-template permissions
  file:
    path: "{{consul_template_bin_path}}/{{ consul_template_binary }}"
    owner: "{{consul_template_user}}"
    group: "{{consul_template_group}}"
    mode: "0755"
  tags:
    - requirements

- name: consul-template config file
  template:
    src: "{{ consul_template_config_file_template }}"
    dest: "{{consul_template_config_dir}}/{{ consul_template_config_file }}"
    mode: 0755
  tags:
    - config

- name: copy consul-template systemd service configuration
  template:
    src: consul-template.service.j2
    dest: /etc/systemd/system/consul-template.service
    mode: 0755
  when: "'Linux' in ansible_system"
  tags:
    - config

- name: copy consul-template bsdinit service configuration
  template:
    src: consul-template.bsdinit.j2
    dest: "{{etc_prefix}}/rc.d/consul-template"
    mode: 0755
  when: "'FreeBSD' in ansible_system"
  tags:
    - config

- name: start consul-template service
  service:
    name: consul-template
    state: started
    enabled: yes
