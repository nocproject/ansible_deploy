- name: Generate NOC config
  template:
    src: "etc/noc.yml.j2"
    dest: "{{ noc_root }}/etc/noc.yml"
  register: noc_cfg1
  tags:
    - config
    - noc_config

- name: Setup supervisor config
  template:
    src: "{{ item }}"
    dest: "{{ noc_root }}/{{ item[:-3] }}"
  with_items:
    - etc/config/supervisor/supervisord.conf.j2
    - etc/config/supervisor/supervisorctl.conf.j2
    - etc/config/supervisor/unix_http_server.conf.j2
  register: noc_cfg2
  tags:
    - config
    - noc_config

- name: Set up noc.conf 1/2
  ini_file:
    dest: "{{noc_root}}/etc/noc.conf"
    section: "{{item.section}}"
    option: "{{item.option}}"
    value: "{{item.value}}"
    create: yes
  with_items:
    - section: main
      option: secret_key
      value: "{{ django_key }}"
    - section: main
      option: language_code
      value: "{{ web_ui_language }}"
    - section: database
      option: name
      value: "{{ noc_pg_db }}"
    - section: database
      option: user
      value: "{{ noc_pg_user }}"
    - section: database
      option: password
      value: "{{ noc_pg_password }}"
    - section: database
      option: host
      value: "{{postgres_master}}"
    - section: nosql_database
      option: name
      value: "{{ noc_mongo_db }}"
    - section: nosql_database
      option: user
      value: "{{ noc_mongo_user }}"
    - section: nosql_database
      option: password
      value: "{{ noc_mongo_password }}"
    - section: nosql_database
      option: host
      value: "{{ groups['svc-mongod'] | join(',') }}"
    - section: nosql_database
      option: replica_set
      value: "{{ noc_mongo_replicaset }}"
    - section: customization
      option: installation_name
      value: "{{ noc_installation_name }}"
  register: noc_cfg3
  tags:
    - config
    - noc_config

- name: Set up noc.conf for sentry 2/2
  ini_file:
    dest: "{{noc_root}}/etc/noc.conf"
    section: "{{item.section}}"
    option: "{{item.option}}"
    value: "{{item.value}}"
    create: yes
  register: noc_cfg4
  with_items:
    - section: main
      option: sentry_url
      value: "{{sentry_url}}"
    - section: main
      option: sentry_js_token
      value: "{{sentry_js_token}}"
  when: "sentry_secret_key is defined and sentry_secret_key
      and sentry_js_token is defined and sentry_js_token"
  tags:
    - config
    - noc_config