- name: add clickhouse data to legacy config
  set_fact:
    noc_config: "{{noc_config | combine({
    'config':{
        'noc':{
            'ch_db': clickhouse_db,
            'ch_user': clickhouse_user,
            'ch_password': clickhouse_password,
            'ch_ro_password': clickhouse_ro_password
        }
    }}, recursive=True) }}"
  tags:
    - config
    - noc_config

- name: Generate NOC config
  template:
    src: "etc/noc.yml.j2"
    dest: "{{ noc_etc }}/noc.yml"
  no_log: true
  tags:
    - config
    - noc_config

- name: Setup supervisor config
  template:
    src: "etc/supervisord.conf.j2"
    dest: "{{ noc_etc }}/supervisord.conf"
  no_log: true
  tags:
    - config
    - noc_config

- name: install services templates
  template:
    src: "etc/services/{{item}}"
    dest: "{{noc_etc}}/services/{{item}}"
    owner: "{{noc_user}}"
    mode: "0644"
  with_items:
    - activator.conf
    - bi.conf
    - card.conf
    - chwriter.conf
    - classifier.conf
    - correlator.conf
    - discovery.conf
    - escalator.conf
    - grafanads.conf
    - login.conf
    - mailsender.conf
    - mrt.conf
    - notebook.conf
    - notifier.conf
    - omap.conf
    - ping.conf
    - sae.conf
    - scheduler.conf
    - sync.conf
    - syslogcollector.conf
    - tgsender.conf
    - trapcollector.conf
    - web.conf
  tags:
    - config
    - noc_config

- name: Build supervisor config
  command: "{{ noc_root }}/scripts/deploy/apply-config {{ ansible_nodename }}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  args:
    chdir: "{{ noc_root }}"
  tags:
    - config
    - noc_config
  environment:
    NOC_CONFIG: "{{config_order}}"

- name: install .env file
  template:
    src: "env.j2"
    dest: "{{noc_root}}/.env"
    owner: "{{noc_user}}"
    mode: "0644"
  tags:
    - config
    - noc_config