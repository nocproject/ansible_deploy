- name: Initialize virtualenv
  pip:
    chdir: "{{noc_root}}"
    name: "pip"
    virtualenv: "{{ noc_root }}"
    state: "present"
  environment:
    https_proxy: "{{http_proxy}}"
    http_proxy: "{{http_proxy}}"
    LC_ALL: C

- name: Fix broken PIP versions
  command: "{{ noc_root }}/scripts/deploy/fix-pip"
  args:
    chdir: "{{ noc_root }}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  environment:
    https_proxy: "{{http_proxy}}"

- name: Upgrade PIP
  pip:
    chdir: "{{noc_root}}"
    virtualenv: "{{noc_root}}"
    name: "pip"
    state: latest
  environment:
    http_proxy: "{{http_proxy}}"
    https_proxy: "{{http_proxy}}"
    LC_ALL: C

- name: Upgrade setuptools
  pip:
    name: setuptools
    chdir: "{{noc_root}}"
    virtualenv: "{{noc_root}}"
    state: latest
  environment:
    http_proxy: "{{http_proxy}}"
    https_proxy: "{{http_proxy}}"
  tags:
    - requirements

- name: Relink site-packages
  command: "{{ noc_root }}/scripts/deploy/link-site-packages"
  args:
    chdir: "{{ noc_root }}"
  register: s
  changed_when: "'CHANGED' in s.stdout"