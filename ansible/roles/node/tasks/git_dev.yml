- block:
  - name: Clone NOC
    shell: git clone "{{noc_repo}}" "{{noc_root}}"
    environment:
      https_proxy: "{{http_proxy}}"

  - name: set up dummy git user email
    git_config:
      name: user.email
      repo: "{{noc_root}}"
      scope: local
      value: 'noc_user@{{ ansible_fqdn }}'
    when: git_user_email.stdout is defined and not git_user_email.stdout

  - name: set up dummy git user name
    git_config:
      name: user.name
      repo: "{{noc_root}}"
      scope: local
      value: 'Noc User {{ansible_fqdn}}'
    when: git_user_email.stdout is defined and not git_user_email.stdout

  when: noc_root_state.stat.exists is defined and not noc_root_state.stat.exists

- name: Pull NOC
  shell: git fetch "{{noc_repo}}"
  args:
    chdir: "{{noc_root}}"
  environment:
    https_proxy: "{{http_proxy}}"
  register: git_pill_status
  changed_when: "'Already up-to-date.' not in git_pill_status.stdout"

- name: Switch to "{{noc_revision}}" branch
  shell: git checkout "{{noc_revision}}"
  args:
    chdir: "{{noc_root}}"
  environment:
    https_proxy: "{{http_proxy}}"
  register: git_pill_status
  changed_when: "'Already up-to-date.' not in git_pill_status.stdout"