#
# node role tasks
#
---
- name: "Include OS-specific tasks"
  include: "os/{{ ansible_distribution }}/main.yml"

- name: Create NOC group
  group:
    name: "{{noc_group}}"
    state: present

- name: Create NOC user
  user:
    name: "{{noc_user}}"
    group: "{{noc_group}}"
    comment: "NOC user"
    state: present

- name: Include {{install_method}} install method
  include: "{{install_method}}.yml"

- name: Include venv init
  include: "init_venv.yml"

- name: Include requirements install
  include: "requirements.yml"

- name: Create required directories
  file:
    path: "{{item.name}}"
    state: "directory"
    owner: "{{item.owner}}"
    mode: 0755
  with_items:
    - name: "{{noc_root}}/etc/config/"
      owner: root
    - name: "{{noc_root}}/etc/config/supervisor"
      owner: root
    - name: "{{noc_root}}/var"
      owner: "{{noc_user}}"
    - name: "{{noc_root}}/var/etc"
      owner: root
    - name: "{{noc_root}}/var/etc/noc"
      owner: root
    - name: "{{noc_root}}/var/db"
      owner: root
    - name: "{{noc_logs}}"
      owner: "{{noc_user}}"
    - name: "{{noc_root}}/var/cp"
      owner: "{{noc_user}}"
    - name: "{{noc_root}}/var/cp/crashinfo"
      owner: "{{noc_user}}"
    - name: "{{noc_root}}/var/cp/crashinfo/new"
      owner: "{{noc_user}}"
    - name: "{{noc_root}}/var/run"
      owner: "{{noc_user}}"
    - name: "{{noc_root}}/lib/python2.7/site-packages/__pycache__"
      owner: "{{ noc_user }}"
    - name: "{{noc_root}}/var/reports"
      owner: "{{noc_user}}"
    - name: "{{bi_export_dir}}"
      owner: "{{noc_user}}"
    - name: "{{bi_export_dict_dir}}"
      owner: "{{noc_user}}"
    - name: "{{bi_export_dict_data_dir}}"
      owner: "{{noc_user}}"

- name: Include post install
  include: "post_install.yml"

- name: Generate configs
  include: "config.yml"

- name: Include noc hacks
  include: "hacks.yml"