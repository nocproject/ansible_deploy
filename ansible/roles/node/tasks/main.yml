#
# node role tasks
#
---
- name: "Include OS-specific tasks"
  include: "os/{{ ansible_distribution }}/main.yml"

- name: Create NOC group
  group:
    name: "{{noc_group}}"
    state: present

- name: Create NOC user
  user:
    name: "{{noc_user}}"
    group: "{{noc_group}}"
    comment: "NOC user"
    state: present

- name: check if noc_root exists
  stat:
    path: "{{noc_root}}"
  register: noc_root_state

- name:
  git_config:
    name: user.email
    scope: global
    repo: "{{noc_root}}"
  register: git_user_email

- block:
  - name: check if noc under mercurial control
    stat:
      path: "{{noc_root}}/.hg"
    register: noc_hg_state

  - name: migrate to git
    include: "migrate_git.yml"
    when: noc_hg_state.stat.exists is defined and noc_hg_state.stat.exists
  when: noc_root_state.stat.exists is defined and noc_root_state.stat.exists

- name: Include {{install_method}} install method
  include: "{{install_method}}.yml"

- name: Include venv init
  include: "init_venv.yml"

- name: Include requirements install
  include: "requirements.yml"

- name: Create dirs
  include: "dirs.yml"

- name: Generate configs
  include: "config.yml"

- name: Include noc hacks
  include: "hacks.yml"

- name: Include post install
  include: "post_install.yml"

