{% for service in noc_services %}
[program:{{service.name}}]
command = {{ service.environment.command  | mandatory }}
process_name = {{ service.environment.process_name | default("%(program_name)s-%(process_num)02d", True) }}
numprocs = {{service.n_instances + service.n_backup_instances | default(0, True)}}
umask = 022
priority = {{ service.environment.priority | default(50, True) }}
autostart = true
autorestart = unexpected
startsecs = {{ service.environment.startsecs  | default(2, True)}}
startretries = 999
exitcodes = 0
stopsignal = TERM
stopwaitsecs = {{ service.environment.stopwaitsecs  | default(50, True)}}
stopasgroup = false
killasgroup = true
{% if 'user' in service.environment %}
user = {{ service.environment.user }}
{% else %}
user = {{ noc_user }}
{% endif -%}
{% if not 'FreeBSD' in ansible_system -%}
oom_score_adj = {{ service.environment.oom_score_adj  | default(50, True) }}
{% endif -%}
redirect_stderr = true
stdout_logfile = {{noc_logs}}/{{ service.environment.process_name | default("%(program_name)s-%(process_num)02d", True) }}.log
stdout_logfile_maxbytes = {{ service.environment.stdout_logfile_maxbytes  | default('10MB', True)}}
stdout_logfile_backups = {{ service.environment.stdout_logfile_backups  | default(3, True)}}
stdout_events_enabled = false
stderr_logfile = {{noc_logs}}/{{ service.environment.process_name | default("%(program_name)s-%(process_num)02d", True) }}.err
stderr_logfile_maxbytes = {{ service.environment.stderr_logfile_maxbytes  | default('10MB', True)}}
stderr_logfile_backups = {{ service.environment.stderr_logfile_backups  | default(3, True)}}
stderr_events_enabled = false
environment=NOC_CONFIG="{{ service.config_order }}",NOC_NODE="{{ ansible_nodename }}",NOC_DC="{{ noc_dc }}",NOC_USER="{{ noc_user }}",NOC_ROOT="{{ noc_root }}",NOC_ENV="{{ noc_env }}",NOC_LOGLEVEL="{{service.loglevel }}"

{%- if not 'FreeBSD' in ansible_system and jemalloc_path -%}
    ,LD_PRELOAD="{{ jemalloc_path }}"
{%- endif -%}

{%- if service.pool -%}
    ,NOC_POOL="{{ service.pool }}"
{%- endif %}

{% endfor %}
