- name: "Include OS-specific tasks"
  include: "os/{{ ansible_distribution }}/main.yml"

- name: install keepalived.conf
  template:
    src: keepalived.conf.j2
    dest: "{{etc_prefix}}/keepalived/keepalived.conf"
  notify: reload keepalived
  tags:
    - keepalived
    - config

- name: install keepalived nginx.cnf
  template:
    src: nginx.cnf.j2
    dest: "{{etc_prefix}}/keepalived/nginx.cnf"
  notify: reload keepalived
  when: has_svc_nginx| default(False)
  tags:
    - keepalived
    - config
    - nginx

- name: install keepalived patroni.cnf
  template:
    src: patroni.cnf.j2
    dest: "{{etc_prefix}}/keepalived/patroni.cnf"
  notify: reload keepalived
  when: has_svc_haproxy| default(False)
  tags:
    - keepalived
    - config
    - patroni

- name: Start keepalived
  service:
    name: keepalived
    state: started
    enabled: yes
  tags:
    - keepalived

- name: copy keepalived_nginx consul templates
  template:
    src: keepalived_nginx.json.j2
    dest: "{{consul_configd_path}}/keepalived_nginx.json"
  notify: reload consul
  when: has_svc_nginx| default(False)
  tags:
    - consul

- name: copy keepalived_nginx check script
  template:
    src: keepalived_nginx.sh.j2
    dest: "{{consul_scripts_path}}/keepalived_nginx.sh"
    mode: u+rx
    owner: "{{consul_user}}"
  notify: reload consul
  when: has_svc_nginx| default(False)
  tags:
    - consul

- name: copy keepalived_patroni consul templates
  template:
    src: keepalived_patroni.json.j2
    dest: "{{consul_configd_path}}/keepalived_patroni.json"
  notify: reload consul
  when: has_svc_haproxy| default(False)
  tags:
    - consul

- name: copy keepalived_patroni check script
  template:
    src: keepalived_patroni.sh.j2
    dest: "{{consul_scripts_path}}/keepalived_patroni.sh"
    mode: u+rx
    owner: "{{consul_user}}"
  notify: reload consul
  when: has_svc_haproxy| default(False)
  tags:
    - consul
