---
- include: "os/{{ ansible_distribution }}/main.yml"

- name: Install influx monitoring
  template:
    src: "etc/telegraf/telegraf.d/influxdb.conf.j2"
    dest: "{{ telegraf_confd_path }}/influxdb.conf"
  tags:
    - config
    - telegraf

- name: Setup InfluxDB config
  template:
    src: etc/influxdb/influxdb.conf.j2
    dest: "{{ influxdb_conf }}"
  notify: restart influxdb
  tags:
    - config

- name: Enable InfluxDB system service
  service:
    name: "{{influxdb_system_service}}"
    enabled: yes
    state: started

- name: Waiting for influx db to finish restart. timeout 20 minutes
  wait_for:
    port: 8086
    timeout: 1200
    state: present

- name: Create InfluxDB database
  command: "{{ influx_path }} -execute 'CREATE DATABASE {{ noc_influxdb_db }}'"

- name: Check InfluxDB user
  shell: "{{ influx_path }} -database {{ noc_influxdb_db }} -execute 'show users' | grep {{noc_influxdb_user}}"
  register: us
  changed_when: "us.rc == 1"
  failed_when: "us.rc > 1"

- name: Create InfluxDB user
  command: "{{ influx_path }} -database {{ noc_influxdb_db }} -execute \"CREATE USER {{noc_influxdb_user}} WITH PASSWORD '{{ noc_influxdb_password }}' WITH ALL PRIVILEGES\""
  when: "us.rc == 1"
