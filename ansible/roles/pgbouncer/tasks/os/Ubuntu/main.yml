- name: Create required directories
  file:
    path: "{{item}}"
    state: "directory"
    mode: 0755
    owner: "{{pgbouncer_user}}"
  with_items:
    - "{{etc_prefix}}/pgbouncer"
    - "/var/log/pgbouncer"

- name: Install pgbouncer config
  template:
    src: "etc/pgbouncer/pgbouncer.ini.j2"
    dest: "{{etc_prefix}}/pgbouncer/pgbouncer.ini"
  notify: reload pgbouncer
  no_log: true
  tags:
    - config

- name: Install pgbouncer
  apt:
    name: pgbouncer
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ http_proxy }}"
  tags:
    - requirements

- name: Install pgbouncer config
  template:
    src: "etc/pgbouncer/pgbouncer.ini.j2"
    dest: "{{ etc_prefix }}/pgbouncer/pgbouncer.ini"
  notify: reload pgbouncer
  no_log: true
  tags:
    - config

- name: Install pgbouncer limits file
  template:
    src: "etc/security/limits.d/pgbouncer_limits.conf.j2"
    dest: "/etc/security/limits.d/pgbouncer_limits.conf"
  tags:
    - config

- name: Install pgbouncer logrotated config
  template:
    src: "etc/pgbouncer.j2"
    dest: "/etc/logrotate.d/pgbouncer.conf"
  when: "'Linux' in ansible_system"
  notify: reload systemd
  tags:
    - config