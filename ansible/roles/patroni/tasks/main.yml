---
- name: create "{{patroni_config_dir}}"
  file:
    state: directory
    dest: "{{patroni_config_dir}}"

- name: Check bootstrapped state
  stat:
    path: "{{patroni_bootstrap_file}}"
  register: patroni_bootstrap_marker
  ignore_errors: true
  tags: always

- name: include patroni os specific tasks
  include: "os/{{ ansible_distribution }}/main.yml"

- name: Upgrade PIP
  pip:
    virtualenv: "{{patroni_path}}"
    name: "pip"
    state: latest
  environment:
    http_proxy: "{{http_proxy}}"
    https_proxy: "{{http_proxy}}"
    LC_ALL: C

- name: install python packages
  pip:
    name: "{{ item }}"
    virtualenv: "{{patroni_path}}"
  with_items:
    - python-consul
    - flake8==3.3.0 # some kind of bug. have to be in list upper than patroni.
    - patroni
    - PyYAML
    - urllib3>=1.10
  environment:
    https_proxy: "{{http_proxy}}"
    http_proxy: "{{http_proxy}}"

- name: install patroni postgres
  template:
    src: postgres0.yml.j2
    dest: "{{patroni_config_dir}}/postgres.yml"
  no_log: true
  register: config_install

- name: include patroni bootstrap
  include: "os/{{ ansible_distribution }}/bootstrap.yml"
  when: not patroni_bootstrap_marker.stat.exists

- name: copy postgres consul templates
  template:
    src: postgres.json.j2
    dest: "{{consul_configd_path}}/postgres.json"
  notify: reload consul
  tags:
    - consul

- name: copy postgres check script
  template:
    src: postgres_check.sh.j2
    dest: "{{consul_scripts_path}}/postgres_check.sh"
    mode: u+rx
    owner: "{{consul_user}}"
  notify: reload consul
  tags:
    - consul
