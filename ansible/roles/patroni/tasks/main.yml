---
- name: include patroni os specific tasks
  include: "os/{{ ansible_distribution }}/main.yml"

- name: create /etc/patroni
  file:
    state: directory
    dest: /etc/patroni

- name: Upgrade PIP
  pip:
    virtualenv: /opt/patroni
    name: "pip"
    state: latest
  environment:
    http_proxy: "{{http_proxy}}"
    https_proxy: "{{http_proxy}}"
    LC_ALL: C

- name: install python packages
  pip:
    name: "{{ item }}"
    virtualenv: /opt/patroni
  with_items:
    - python-consul
    - flake8==3.3.0 # some kind of bug. have to be in list upper than patroni.
    - patroni
    - PyYAML
    - urllib3>=1.10
  environment:
    https_proxy: "{{http_proxy}}"
    http_proxy: "{{http_proxy}}"

- name: install patroni postgres
  template:
    src: postgres0.yml.j2
    dest: /etc/patroni/postgres.yml
  notify: restart patroni

- name: start patroni
  service:
    name: patroni
    state: started
    enabled: yes
  when: "has_svc_postgres_master | default(False)"

- name: Waiting for patroni on master
  wait_for:
    host: "0.0.0.0"
    port: "{{patroni_listen}}"
    timeout: 30
    state: present
  when: "has_svc_postgres_master | default(False)"

- name: start patroni on slaves
  service:
    name: patroni
    state: started
    enabled: yes
  when: "not has_svc_postgres_master | default(False)"