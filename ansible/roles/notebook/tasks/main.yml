---
- include: "os/{{ ansible_distribution }}/main.yml"

- name: Install notebook monitoring
  template:
    src: "etc/telegraf/telegraf.d/notebook.conf.j2"
    dest: "{{etc_prefix}}/telegraf/telegraf.d/notebook.conf"
  notify: reload telegraf
  tags:
    - config
    - telegraf

- name: Install packages
  pip:
    chdir: "{{noc_root}}"
    requirements: "requirements/notebook.txt"
    virtualenv: "{{noc_root}}"
    extra_args: "--trusted-host cdn.getnoc.com --find-links https://cdn.getnoc.com/npkg/simple/ --allow-all-external --upgrade"
  environment:
    https_proxy: "{{http_proxy}}"
    http_proxy: "{{http_proxy}}"

- name: Create etc notebook directories
  file:
    path: "{{ noc_etc }}/{{ item }}"
    owner: "{{ noc_user }}"
    mode: 0700
    state: directory
  with_items:
    - jupyter
    - jupyter/profile_default
    - jupyter/profile_default/startup

- name: Create var notebook directories
  file:
    path: "{{ noc_var }}/{{ item }}"
    owner: "{{ noc_user }}"
    mode: 0700
    state: directory
  with_items:
    - notebooks
    - jupyter
    - jupyter/runtime

- name: Set up configs
  template:
    src: "etc/jupyter/{{ item }}"
    dest: "{{ noc_etc }}/jupyter/{{ item[:-3] }}"
  with_items:
    - jupyter_notebook_config.py.j2
    - profile_default/ipython_kernel_config.py.j2
    - profile_default/startup/00-logging.py.j2
  tags:
    - config