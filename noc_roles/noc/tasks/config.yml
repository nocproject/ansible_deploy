---
- name: Setup supervisor config
  template:
    src: "etc/supervisord.conf.j2"
    dest: "{{ noc_etc }}/supervisord.conf"
  no_log: "{{tower_show_secrets}}"

- name: Build services config
  template:
    src: "etc/noc_services.conf.j2"
    dest: "{{noc_root}}/etc/noc_services.conf"
    owner: "{{noc_user}}"
    mode: "0640"
  when:
    - noc_services is defined
    - noc_services

- name: Generate NOC config
  template:
    src: "etc/tower.yml.j2"
    dest: "{{ noc_etc }}/tower.yml"
  no_log: "{{tower_show_secrets}}"
  when:
    - noc_services is defined
    - noc_services

- name: Generate NOC config for pooled services
  template:
    src: "etc/pooled.yml.j2"
    dest: "{{ noc_etc }}/pool-{{item.name}}.yml"
  no_log: "{{tower_show_secrets}}"
  when:
    - noc_services is defined
    - noc_services
  vars:
    pool_name: "{{item.name}}"
  with_items:
    - "{{noc_all_pools}}"

- name: Build pools config
  template:
    src: "etc/pools.yml.j2"
    dest: "{{noc_root}}/etc/noc.yml"
    owner: "{{noc_user}}"
    mode: "0640"

- name: install .env file
  template:
    src: "env.j2"
    dest: "{{noc_root}}/.env"
    owner: "{{noc_user}}"
    mode: "0644"
  no_log: "{{tower_show_secrets}}"

- name: remove services templates
  file:
    src: "etc/services/{{item}}"
    dest: "{{noc_etc}}/services/{{item}}"
    owner: "{{noc_user}}"
    mode: "0644"
    state: absent
  with_items:
    - activator.conf
    - bi.conf
    - card.conf
    - chwriter.conf
    - classifier.conf
    - correlator.conf
    - discovery.conf
    - escalator.conf
    - grafanads.conf
    - login.conf
    - mailsender.conf
    - mrt.conf
    - notebook.conf
    - notifier.conf
    - omap.conf
    - ping.conf
    - sae.conf
    - scheduler.conf
    - sync.conf
    - syslogcollector.conf
    - tgsender.conf
    - trapcollector.conf
    - web.conf
