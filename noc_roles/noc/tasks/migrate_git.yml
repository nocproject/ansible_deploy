---
- name: archive current noc dir
  archive:
    path: "{{noc_root}}"
    dest: "{{noc_root}}/../noc_before_git_migrations.tbz"
    format: bz2

- name: add everything to mercurial
  command: hg add .
  args:
    chdir: "{{noc_root}}"
  tags:
    - skip_ansible_lint

- name: make diff
  shell: hg diff > /tmp/noc_diff.diff
  args:
    chdir: "{{noc_root}}"
  tags:
    - skip_ansible_lint

- name: reset current dir
  hg:
    repo: "{{noc_root}}"
    dest: "{{noc_root}}"
    revision: "feature/microservices"
    force: "True"
    purge: "True"

- name: remove .hg
  file:
    path: "{{noc_root}}/.hg"
    state: absent
  register: hg_removed

- name: git init
  command: git init "{{noc_root}}"
  when: hg_removed is changed
  creates: "{{noc_root}}/./git"
  tags:
    - skip_ansible_lint

- block:
    - name: set up dummy git user email
      git_config:
        name: user.email
        repo: "{{noc_root}}"
        scope: local
        value: 'noc_user@{{ ansible_fqdn }}'

    - name: set up dummy git user name
      git_config:
        name: user.name
        repo: "{{noc_root}}"
        scope: local
        value: 'Noc User {{ansible_fqdn}}'
  when: not git_user_email.config_value

- name: add correct origin
  git_config:
    name: remote.upstream.url
    value: "{{noc_repo}}"
    repo: "{{noc_root}}"
    scope: local

- name: git reset branch
  git:
    repo: "{{noc_repo}}"
    dest: "{{noc_root}}"
    version: "{{noc_version}}"
    force: "True"
    clone: "True"
  environment:
    https_proxy: "{{http_proxy}}"

- name: patch new dir with old hg
  patch:
    src: /tmp/noc_diff.diff
    strip: 1
  args:
    chdir: "{{noc_root}}"
