---
- name: Tune sysctl.conf for node
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: "True"
  with_items:
    - { name: 'net.ipv4.ip_local_port_range', value: '20024 65000'}
  tags:
    - config
  when: "'Linux' in ansible_system"

- name: Register supervisord's version 1/2
  slurp:
    src: "{{ noc_root }}/requirements/node.txt"
<<<<<<< HEAD
<<<<<<< HEAD
  register: node_req
  tags:
    - config
<<<<<<< HEAD

- name: Register supervisord's version 2/2
  set_fact:
    sup_ver: "{{ node_req['content'] | b64decode | regex_search('supervisor==(\\d+.\\d+.\\d+)', '\\1') | first }}"
  tags:
    - config
=======
  register: node-req
=======
  register: node_req
>>>>>>> Add different supervisor's configs patch
=======
>>>>>>> Final fix of supervisor's patch mechanism

- name: Register supervisord's version 2/2
<<<<<<< HEAD
    set_fact:
      sup_ver: "{{ node-req['content'] | regex_search('^supervisor==(\d.\d.\d)$', '\\1') }}"
>>>>>>> Add different supervisor's configs patch
=======
  set_fact:
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    sup_ver: "{{ node-req['content'] | regex_search('^supervisor==(\d.\d.\d)$', '\\1') }}"
>>>>>>> Add different supervisor's configs patch
=======
    sup_ver: "{{ node-req['content'] | regex_replace('^supervisor==(\d.\d.\d)$', '\\1') }}"
>>>>>>> Add different supervisor's configs patch
=======
    sup_ver: "{{ node-req['content'] | regex_replace('^supervisor==(\\d.\\d.\\d)$', '\\\\1') }}"
>>>>>>> Add different supervisor's configs patch
=======
    sup_ver: "{{ node_req['content'] | regex_replace('^supervisor==(\\d.\\d.\\d)$', '\\\\1') }}"
>>>>>>> Add different supervisor's configs patch
=======
    sup_ver: "{{ node_req['content'] | regex_search('^supervisor==(\\d.\\d.\\d)$', '\\\\1') }}"
>>>>>>> Fix regex
=======
    sup_ver: "{{ node_req['content'] | b64decode | regex_replace('^supervisor==(\\d.\\d.\\d)$', '\\\\1') }}"
<<<<<<< HEAD
>>>>>>> Add decode cause "should read docs", file's content in b64 by default
=======
  tags:
    - config
>>>>>>> Final fix of supervisor's patch mechanism

- name: patch supervisord for oomkiller
  patch:
    basedir: "{{ noc_root }}"
    src: "oom_score_adj_v{{ sup_ver }}.patch"
<<<<<<< HEAD
=======
    strip: 1
>>>>>>> Add different supervisor's configs patch
  tags:
    - config
  when:
    - "'Linux' in ansible_system"
    - "'prod' in noc_env_type"
    - noc_python_interpreter is search "python"
