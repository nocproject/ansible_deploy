#
# node role tasks
#
---
- name: "Include OS-specific tasks"
  include_tasks: "os/{{ ansible_distribution }}/main.yml"

- name: Create NOC group
  group:
    name: "{{noc_group}}"
    state: present

- name: Create NOC user
  user:
    name: "{{noc_user}}"
    group: "{{noc_group}}"
    comment: "NOC user"
    state: present

- name: check if noc_root exists
  stat:
    path: "{{noc_root}}"
  register: noc_root_state

- name:
  git_config:
    name: user.email
    scope: global
    repo: "{{noc_root}}"
  register: git_user_email

- block:
    - name: check if noc under mercurial control
      stat:
        path: "{{noc_root}}/.hg"
      register: noc_hg_state

    - name: migrate to git
      include_tasks: "migrate_git.yml"
  when:
    - noc_root_state.stat.exists is defined
    - noc_root_state.stat.exists

- name: Include {{install_method}} install method
  include_tasks: "{{install_method}}.yml"

- name: Include venv init for {{python_interpreter}}
  include_tasks: "init_venv_{{python_interpreter}}.yml"

- name: Include requirements install
  import_tasks: "requirements.yml"

- name: Create dirs
  import_tasks: "dirs.yml"

- name: Generate configs
  import_tasks: "config.yml"
  tags:
    - config
    - noc_config

- name: Include noc hacks
  import_tasks: "hacks.yml"

- name: Include post install
  import_tasks: "post_install.yml"
