- name: Compile bytecode
  command: ./scripts/deploy/compile-bytecode
  args:
    chdir: "{{noc_root}}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  failed_when: "'ERROR' in result.stdout"
  environment:
    NOC_CONFIG: "{{config_order}}"

- name: Compiling binary modules
  command: ./scripts/deploy/cythonize
  args:
    chdir: "{{noc_root}}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  failed_when: "'ERROR' in result.stdout"
  environment:
    NOC_CONFIG: "{{config_order}}"
  tags:
    - requirements
    - get_source

- name: Cleanup hanging .pyc files
  command: ./scripts/deploy/cleanup-pyc
  args:
    chdir: "{{noc_root}}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  failed_when: "'ERROR' in result.stdout"
  tags:
    - get_source

- name: migrate ch db
  command: ./noc migrate-ch --host 127.0.0.1
  args:
    chdir: "{{ noc_root }}"
  when: "has_svc_clickhouse | default(False)"
  tags:
    - migrate

- name: check if noc running
  command: "{{ noc_root }}/noc ctl status"
  changed_when: false
  register: noc_ctl_status
  tags:
    - config
    - soft_restart
    - noc_config

- name: Reread config
  command: "{{ noc_root }}/noc ctl reread"
  when: "'RUNNING' in noc_ctl_status.stdout"
  register: noc_ctl_reread
  tags:
    - config
    - soft_restart
    - noc_config