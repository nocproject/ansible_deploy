---
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> Add python path vars
- name: gather py3 facts
  vars:
    ansible_python_interpreter: /usr/bin/python3
  setup:
    gather_subset:
      - 'min'

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> Add checks and cleaning of folders
- name: Check if we have NOC/bin/ folder with py2
  register: noc_bin_py2
  stat:
    path: "{{ noc_root }}/bin/python2"

- name: Archive old py2 noc folder and delete files in /var/lib
  block:
    - name: archive current noc dir
      archive:
        path: "{{noc_root}}"
        dest: "{{noc_root}}/../noc_on_python2.tbz"
        format: bz2

    - name: Delete old folders
      file:
        state: absent
        path: "{{ item }}"
      with_items:
<<<<<<< HEAD
        - "{{ noc_root }}"
        - /var/lib/noc/var/pkg

    - name: Reinitialize git
      include_tasks: "git.yml"

=======
        - {{ noc_root }}
        - /var/lib/noc/var/pkg
>>>>>>> Add checks and cleaning of folders
  when:
    - noc_bin_py2 is defined
    - noc_bin_py2.stat.exists

<<<<<<< HEAD
=======
>>>>>>> Add python path vars
- name: Initialize virtualenv3
=======
- name: Initialize virtualenv
>>>>>>> Try to add python3 choice
=======
=======
>>>>>>> Add checks and cleaning of folders
- name: Initialize virtualenv3
>>>>>>> Fix mistype
  pip:
    chdir: "{{ noc_root }}"
    name: "pip"
    virtualenv: "{{ noc_root }}"
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    virtualenv_python: /usr/bin/python3
=======
>>>>>>> Try to add python3 choice
=======
    virtualenv_python: "/usr/bin/python3"
>>>>>>> Move virtualenv to py3
=======
    virtualenv_python: /usr/bin/python3
>>>>>>> Delete quotes
    state: "latest"
  environment:
    https_proxy: "{{ http_proxy }}"
    http_proxy: "{{ http_proxy }}"
    LC_ALL: C

- name: Install wheel
  pip:
    name: wheel
    chdir: "{{ noc_root }}"
    virtualenv: "{{ noc_root }}"
    state: present
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ http_proxy }}"
  tags:
    - requirements

<<<<<<< HEAD
<<<<<<< HEAD
=======
- name: Fix broken PIP versions
  command: "{{ noc_root }}/scripts/deploy/fix-pip"
  args:
    chdir: "{{ noc_root }}"
  register: result
  changed_when: "'CHANGED' in result.stdout"
  environment:
    https_proxy: "{{ http_proxy }}"

>>>>>>> Try to add python3 choice
=======
>>>>>>> Remove unused roles
- name: Upgrade setuptools
  pip:
    name: setuptools
    chdir: "{{ noc_root }}"
    virtualenv: "{{ noc_root }}"
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ http_proxy }}"
  tags:
    - requirements

- name: Install mercurial for freebsd
  pip:
    chdir: "{{ noc_root }}"
    name: "mercurial"
    virtualenv: "{{ noc_root }}"
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ http_proxy }}"
    PATH: "{{ ansible_env.PATH }}:/usr/pgsql-{{ postgres_version }}/bin/"
  tags:
    - requirements
  when: "'FreeBSD' in ansible_system"

- name: Install node python packages(should take a while for a first time)
  pip:
    chdir: "{{ noc_root }}"
    requirements: "requirements/node.txt"
    virtualenv: "{{ noc_root }}"
    extra_args: "--trusted-host cdn.getnoc.com --find-links https://cdn.getnoc.com/npkg/simple/ --upgrade"
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ http_proxy }}"
    PATH: "{{ ansible_env.PATH }}:/usr/pgsql-{{ postgres_version }}/bin/"
    CFLAGS: "{{ pip_cflags | default('') }}"
    LDFLAGS: "{{ pip_ldflags | default('') }}"
  tags:
    - requirements

- name: Install noc.pth
  template:
<<<<<<< HEAD
<<<<<<< HEAD
    src: "lib/python/site-packages/noc.pth.j2"
<<<<<<< HEAD
    dest: "{{ noc_root }}/lib/python{{ ansible_python.version.major }}.{{ ansible_python.version.minor }}/site-packages/noc.pth"
=======
=======
    src: "lib/python{{ ansible_distribution_major_version }}.{{ ansible_python.version.major }}/site-packages/noc.pth.j2"
>>>>>>> Add python path vars
    dest: "{{ noc_root }}/lib/python/site-packages/noc.pth"
=======
    src: "lib/python/site-packages/noc.pth.j2"
    dest: "{{ noc_root }}/lib/python{{ ansible_python.version.major }}.{{ ansible_python.version.minor }}/site-packages/noc.pth"
<<<<<<< HEAD
>>>>>>> Add python path vars fixed

- name: Update site.py
  replace:
    dest: "{{ noc_root }}/lib/python{{ ansible_python.version.major }}.{{ ansible_python.version.minor }}/site.py"
    regexp: "encoding = ['\"]ascii['\"]"
    replace: "encoding = 'utf-8'"
  tags:
    - config
>>>>>>> Try to add python3 choice
=======
>>>>>>> Remove unused encode replacement
