- name: Check ansible version
  fail:
    msg: "{{ ansible_version.full }} is not supported by this role. Please use at least 2.3.0.0. See https://code.getnoc.com/noc/tower/blob/master/UPDATING.md for details."
  when: ansible_version is defined and ansible_version.full | version_compare('2.4.0.0', '<')

- name: Check distribution compatibility
  fail:
    msg: "{{ ansible_distribution }} is not supported by NOC"
  when: ansible_distribution not in ['RedHat', 'CentOS', 'Debian', 'Ubuntu', 'FreeBSD']

- name: Fail if not a new release of Red Hat / CentOS
  fail:
    msg: "{{ ansible_distribution_version }} is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution in ['RedHat', 'CentOS'] and ansible_distribution_version|version_compare(7, '<')

- name: Fail if not a new release of Debian
  fail:
    msg: "{{ ansible_distribution_version }} is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution == "Debian" and ansible_distribution_version|version_compare(8.0, '<')

- name: Fail if too new release of Debian
  fail:
    msg: "{{ ansible_distribution_version }} currently is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution == "Debian" and ansible_distribution_version|version_compare(9.0, '>=')

- name: Fail for a new release of Ubuntu
  fail:
    msg: "{{ ansible_distribution_version }} is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution == "Ubuntu" and ansible_distribution_version|version_compare("16.10", '>')

- name: Fail for a old release of Ubuntu
  fail:
    msg: "{{ ansible_distribution_version }} is not an acceptable version of {{ ansible_distribution }} for this role"
  when: ansible_distribution == "Ubuntu" and ansible_distribution_version|version_compare("16.10", '<')

- block:
  - name: tower version is too old
    fail:
      msg: "tower version is '{{tower_version}}' the minimum version is '{{tower_minimum_version}}'. \n\n\n See https://code.getnoc.com/noc/tower/blob/master/UPDATING.md  \n\n\n "
    when: "'old' in tower_version"

  - name: tower version is old
    fail:
      msg: |

        tower version is '{{tower_version}}' the minimum version is '{{tower_minimum_version}}'.

        See https://code.getnoc.com/noc/tower/blob/master/UPDATING.md

    when: "tower_version|version_compare(tower_minimum_version, '<')"
  when: tower_version != ''

#- name: Proxy url set correctly
#  fail:
#    msg: "Proxy server have to be in defined with scheme for example http://admin:password@192.168.1.1:3128. currently it is: '{{http_proxy}}'"
#  when: "'http://' not in http_proxy and 'https://' not in http_proxy and proxy is defined"
