---
- name: check firewalld state
  systemd:
    name: firewalld
  check_mode: yes
  become: true
  register: firewalld_state
  tags:
    - config
    - firewall

- name: Add firewall permissions for nodes
  firewalld:
    rich_rule: "rule family='ipv4' source address={{ hostvars[item].ansible_host}} accept"
    permanent: true
    state: enabled
    immediate: true
  become: true
  with_items: "{{ groups['all'] }}"
  when: "firewalld_state.status.ActiveState == 'active'"
  tags:
    - config
    - firewall

- name: Add firewall permissions for tower
  firewalld:
    rich_rule: "rule family='ipv4' source address={{ tower_ip }} accept"
    permanent: true
    state: enabled
    immediate: true
  become: true
  when: "firewalld_state.status.ActiveState == 'active'"
  tags:
    - config
    - firewall
