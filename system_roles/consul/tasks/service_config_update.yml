---
- name: import path to control repo
  include_vars: "vars/{{ ansible_distribution }}.yml"

# https://github.com/ansible/ansible/issues/18665#issuecomment-350144774
- name: Ansible full of bugs
  set_fact:
    ansibe_correct_python: "{{ansible_python_interpreter}}"
    ansible_python_interpreter: "{{consul_control_python}}"

# Read default value.
- name: Read key/value pair for key {{consul_service_key}}
  consul_kv:
    key: "{{consul_service_key}}"
    cas: 0
    #token: "{{consul_service_token}}"
  register: consul_key_response

# if default value is unset provide default json
# waiting for https://github.com/ansible/ansible/pull/32738
- name: init default if unset
  consul_kv:
    key: "{{consul_service_key}}"
    cas: "{{consul_key_response.index}}"
    value: "{{ service_tmpl | to_nice_json }}"
  vars:
    service_tmpl:
      Holders: []
      Limit: "{{consul_service_value | int}}"
  when: not consul_key_response.data.Value

# if json is already valid just update needed value
- name: Update a key/value pair for key {{consul_service_key}}
  consul_kv:
    key: "{{consul_service_key}}"
    value: "{{ consul_key_response.data.Value
      | from_json
      | combine({ consul_service_internal_key: consul_service_value })
      | to_nice_json
      }}"
    cas: "{{consul_key_response.index}}"
    #token: "{{consul_service_token}}"
  when: consul_key_response.data.Value

- name: Ansible full of bugs 2
  set_fact:
    ansible_python_interpreter: "{{ansibe_correct_python}}"