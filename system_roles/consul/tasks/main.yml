---
# File: main.yml - Main tasks for Consul

- name: Expose consul_node_role as fact
  set_fact:
    consul_node_role: "{{ consul_node_role }}"
  tags:
    - config

- name: "Include OS-specific tasks"
  include_tasks: "os/{{ ansible_distribution }}/main.yml"

- name: Check bootstrapped state
  stat:
    path: "{{consul_config_path}}/.consul_bootstrapped"
  register: bootstrap_marker
  ignore_errors: true
  tags: always

- name: Include user/group settings
  import_tasks: user_group.yml

- name: Include dir settings
  import_tasks: dirs.yml

- name: Install OS packages and consul - remotely
  import_tasks: install.yml

- name: Consul config
  import_tasks: config.yml
  tags:
    - config

- name: ACL config
  include_tasks: acl.yml
  when: consul_acl_enable
  tags:
    - config

- block:
  - name: Start Consul
    service:
      name: consul
      state: started
      enabled: yes

  - name: Consul HTTP API reachable? wait for port 8500 for 60 seconds
    wait_for:
      delay: 15
      port: 8500
      timeout: 60

  - name: Create bootstrapped marker
    file:
      dest: "{{consul_config_path}}/.consul_bootstrapped"
      state: touch
  when: not bootstrap_marker.stat.exists

- name: Install consul monitoring
  template:
    src: "etc/telegraf/telegraf.d/consul.conf.j2"
    dest: "{{ telegraf_confd_path }}/consul.conf"
  when:
    - "'svc-telegraf' in groups"
    - "inventory_hostname in groups['svc-telegraf-exec']"
  notify: reload telegraf
  tags:
    - config
    - telegraf
