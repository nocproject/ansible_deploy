---
# File: main.yml - Main tasks for Consul

- name: make servers group
  add_host:
    group: svc-consul-server
    host: "{{item}}"
  with_items: "{{groups['svc-consul-exec']}}"
  when: "'bootstrap' in hostvars[item]['consul_power'] or 'server' in hostvars[item]['consul_power']"

# Add user
- name: Add Consul user
  user:
    name: "{{ consul_user }}"
    comment: "Consul user"
    group: "{{ consul_group }}"
    system: yes
    home: "{{ consul_home }}"

- name: "Include OS-specific tasks"
  include_tasks: "os/{{ ansible_distribution }}/main.yml"

- name: Check bootstrapped state
  stat:
    path: "{{consul_config_path}}/.consul_bootstrapped"
  register: bootstrap_marker
  when: consul_power == 'bootstrap'
  ignore_errors: true
  tags: always

- name: Include dir settings
  import_tasks: dirs.yml

- name: Install OS packages and consul - remotely
  import_tasks: install.yml
  tags:
    - requirements

- name: Consul config
  import_tasks: config.yml
  tags:
    - config

- name: ACL config
  include_tasks: acl.yml
  when: consul_acl_enable
  tags:
    - config

- name: Start Consul
  service:
    name: consul
    state: started
    enabled: yes

- block:
  - name: Consul HTTP API reachable? wait for port 8500 for 60 seconds
    wait_for:
      delay: 15
      port: 8500
      timeout: 60

  - name: Create bootstrapped marker
    file:
      dest: "{{consul_config_path}}/.consul_bootstrapped"
      state: touch
  when: consul_power == 'bootstrap' and not bootstrap_marker.stat.exists

- name: Install consul monitoring
  template:
    src: "etc/telegraf/telegraf.d/consul.conf.j2"
    dest: "{{ telegraf_confd_path }}/consul.conf"
  when:
    - "'svc-telegraf' in groups"
    - "inventory_hostname in groups['svc-telegraf-exec']"
  notify: reload telegraf
  tags:
    - config
    - telegraf
