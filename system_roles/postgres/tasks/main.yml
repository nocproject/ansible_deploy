---
# http://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0008238.html?lang=ru
- name: tune systcl for PostgesSQL
  sysctl:
    name: "{{item.name}}"
    value: "{{item.value}}"
    state: present
    reload: yes
  with_items:
    - { name: kernel.shmmax, value: "{{ kernel_shmmax }}" }
    - { name: kernel.shmall, value: "{{ kernel_shmall }}" }
    - { name: kernel.sem, value: '250 256000 400 4096' }
  tags:
    - config
  when: "'Linux' in ansible_system"

- include_tasks: "os/{{ ansible_distribution }}/main.yml"

- name: Setting pg_hba.conf
  lineinfile:
    dest: "{{postgresql_hba_path}}"
    line: "host    all             all             0.0.0.0/0            md5"
  notify: reload postgres
  tags:
    - config

- name: Including postgres.conf
  lineinfile:
    dest: "{{postgresql_conf_path}}"
    line: "include = '{{ postgresql_conf_prefix }}/noc.conf'"
  notify: restart postgres
  tags:
    - config

- name: Setting config
  template:
    src: "postgres.conf.j2"
    dest: "{{ postgresql_conf_prefix }}/noc.conf"
  notify: restart postgres
  tags:
    - config

- name: Enable postgres system service
  service:
    name: "{{postgres_system_service}}"
    enabled: yes
    state: started

- name: place postgres consul check
  import_role:
    name: consul
    tasks_from: service
  vars:
    consul_service_name: postgres
    consul_service_tags: ""
    consul_service_port: 5432
    consul_service_check_type: "script"
    consul_service_check_value: "postgres_check.sh"
    consul_service_check_interval: "10s"
    consul_service_check_http_skip_verify: False
    consul_service_check_script: postgres_check.sh.j2

#- name: copy postgres check script
#  template:
#    src: postgres_check.sh.j2
#    dest: "{{consul_scripts_path}}/postgres_check.sh"
#    mode: u+rx
#    owner: "{{consul_user}}"
#  no_log: true
#  notify:
#    - reload consul
#  tags:
#    - consul

- name: Install postgres monitoring
  template:
    src: "etc/telegraf/telegraf.d/postgres.conf.j2"
    dest: "{{ telegraf_confd_path }}/postgres.conf"
  notify: reload telegraf
  when:
    - "'svc-telegraf' in groups"
    - "inventory_hostname in groups['svc-telegraf-exec']"
  no_log: true
  tags:
    - config
    - telegraf

- meta: flush_handlers

