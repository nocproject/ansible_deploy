---
- include_tasks: "os/{{ ansible_distribution }}/main.yml"

- name: Setting pg_hba.conf
  lineinfile:
    dest: "{{postgresql_hba_path}}"
    line: "host    all             all             0.0.0.0/0            md5"
  notify: reload postgres
  tags:
    - config

- name: Including postgres.conf
  lineinfile:
    dest: "{{postgresql_conf_path}}"
    line: "include = '{{ postgresql_conf_prefix }}/noc.conf'"
  notify: restart postgres
  tags:
    - config

- name: Setting config
  template:
    src: "postgres.conf.j2"
    dest: "{{ postgresql_conf_prefix }}/noc.conf"
  notify: restart postgres
  tags:
    - config

- name: Enable postgres system service
  service:
    name: "{{postgres_system_service}}"
    enabled: yes
    state: started

- name: place postgres consul check
  import_role:
    name: consul
    tasks_from: service
  vars:
    consul_service_name: postgres
    consul_service_tags: ""
    consul_service_port: 5432
    consul_service_check_type: "script"
    consul_service_check_value: "postgres_check.sh"
    consul_service_check_interval: "10s"
    consul_service_check_http_skip_verify: False
    consul_service_check_script: postgres_check.sh.j2

- name: Install postgres monitoring
  include_role:
    name: monitoring
    tasks_from: monitor
  vars:
    monitoring_service_name: postgresql
    monitoring_service_tags: ""
    monitoring_service_port: 5432
    monitoring_service_address: "{{ ansible_host }}"
    monitoring_service_check_interval: "10s"
    monitoring_service_procstat_check: False
    monitoring_config:
        address: "host={{ ansible_host }} user={{postgres_noc_user}} password={{postgres_noc_password}} sslmode=disable database={{postgres_noc_db}}"
        ignored_databases: ["postgres", "template0", "template1"]
  when: has_svc_monitoring is defined
  tags:
    - monitoring

- meta: flush_handlers

