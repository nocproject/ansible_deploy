---
stages:
  - lint
  - build

lint:
  stage: lint
  image: registry.getnoc.com/infrastructure/ansible_linter:master
  script:
    - export ANSIBLE_ROLES_PATH=./additional_roles:./system_roles:./noc_roles
    - export ANSIBLE_LIBRARY=./library:./system_roles/mongod/library
    - yamllint .
    - ansible-lint */*/service.yml -v
    - ansible-playbook */*/service.yml --syntax-check
    - git ls-files | grep -v molecule/| xargs ansible-review -c .ansible-review -q
  tags:
    - docker

build_centos:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/yum
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s default
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist

build_debian8:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s debian8
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist

build_debian9:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s debian9
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist

build_ubuntu16:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s ubuntu16
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist

build_ubuntu18:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s ubuntu18
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist
  allow_failure: true

build_freebsd:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/pkg
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s freebsd
  tags:
    - docker
  cache:
    paths:
      - /tmp/dist

build_rhel:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/yum
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s rhel
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist
  allow_failure: true

build_oel7:
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:ansible_2_6_5
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/yum
  script:
    - echo ${ssh_identity_text} | tr -d ' ' | base64 -d > /tmp/temporary_ssh_key
    - chmod 0400 /tmp/temporary_ssh_key
    - molecule test -s oel7
  tags:
    - docker
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist
  allow_failure: true
