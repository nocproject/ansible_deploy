---
stages:
  - lint
  - build

variables:
  ANSIBLE_FORCE_COLOR: 'true'

lint:
  stage: lint
  image: registry.getnoc.com/infrastructure/ansible_linter:master
  script:
    - export ANSIBLE_ROLES_PATH=./additional_roles:./system_roles:./noc_roles
    - export ANSIBLE_LIBRARY=./library:./system_roles/mongod/library
    - yamllint --version
    - yamllint -s .
    - ansible-playbook --version
    - ansible-playbook */*/service.yml --syntax-check
    - ansible-lint --version
    #- ansible-lint */*/service.yml -v
    - ansible-review --version
    - git ls-files | grep -v molecule/| xargs ansible-review -c .ansible-review -q
  tags:
    - docker
    - cloud

.base_builder: &base_builder
  stage: build
  image: registry.getnoc.com/infrastructure/molecule-docker:master
  script:
    - molecule --version
    - ansible-playbook --version
    - molecule test -s $SCENARIO_NAME
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - /tmp/dist
  only:
    - branches@noc/ansible_deploy
    - master@noc/ansible_deploy

build_centos:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/yum
    SCENARIO_NAME: default
  tags:
    - cloud
    - docker
  <<: *base_builder

build_debian9:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
    SCENARIO_NAME: debian9
  tags:
    - cloud
    - docker
  <<: *base_builder

build_debian10:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
    SCENARIO_NAME: debian10
  tags:
    - cloud
    - docker
  <<: *base_builder
  allow_failure: true

build_ubuntu16:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
    SCENARIO_NAME: ubuntu16
  tags:
    - satel
    - docker
  <<: *base_builder

build_ubuntu18:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/apt/archives
    SCENARIO_NAME: ubuntu18
  tags:
    - cloud
    - docker
  <<: *base_builder

build_freebsd:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/pkg
    SCENARIO_NAME: freebsd
    USE_CACHE: "False"  # freebsd minio-client "broken"
  tags:
    - satel
    - docker
  <<: *base_builder
  allow_failure: true  # to hard to maintain without maintainer. often incompatible changes

build_oel7:
  variables:
    PIP_CACHE: /root/.cache/pip
    PKG_CACHE: /var/cache/yum
    SCENARIO_NAME: oel7
  tags:
    - satel
    - docker
  <<: *base_builder
  allow_failure: true  # no active users for platform
